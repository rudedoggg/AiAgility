#!/usr/bin/env bash
# post-checkout hook — syncs governance files after branch switch
# Arguments: $1 = previous HEAD, $2 = new HEAD, $3 = flag (1=branch checkout, 0=file checkout)

PREV_HEAD="$1"
NEW_HEAD="$2"
CHECKOUT_TYPE="$3"

# Only run on branch checkouts, not file checkouts
if [ "$CHECKOUT_TYPE" != "1" ]; then
  exit 0
fi

# Don't run if we're on the same commit (no actual change)
if [ "$PREV_HEAD" = "$NEW_HEAD" ]; then
  exit 0
fi

REPO_ROOT="$(git rev-parse --show-toplevel)"

# Check if governance files differ between old and new HEAD
GOVERNANCE_FILES="CONSTITUTION.md CLAUDE.md .cursorrules replit.md governance/global-template.md"
CHANGED=false

for file in $GOVERNANCE_FILES; do
  if git diff --name-only "$PREV_HEAD" "$NEW_HEAD" -- "$file" 2>/dev/null | grep -q .; then
    CHANGED=true
    break
  fi
done

if [ "$CHANGED" = true ]; then
  echo "[hook] Governance files differ on this branch — running sync..."
  bash "$REPO_ROOT/script/sync-governance.sh" --skip-fetch
fi
